伊斯坦布尔拜占庭容错（IBFT）共识受到 [Castro-Liskov 99](https://pmg.csail.mit.edu/papers/osdi99.pdf) 论文的启发。
IBFT 继承了原始 PBFT，采用了 3 阶段共识：PRE-PREPARE、PREPARE 和 COMMIT。系统在 N 个验证者网络中最多可以容忍 F 个故障节点，其中
N = 3F + 1。 实现

## 术语
- 验证者（Validator）：区块验证参与者。
- 提议者（Proposer）：在共识轮中被选中提出区块的验证参与者。
- 轮（Round）：共识轮。一个轮次从提议者创建一个区块提议开始，以区块的承诺或轮次变更结束。
- 提议（Proposal）：正在进行共识处理的新区块生成提议。
- 序号（Sequence）：提议的序号。序号应大于所有先前的序号。目前，每个提议的区块高度即为其相关序号。
- Backlog：用于保存未来共识消息的存储。
- 轮次状态（Round state）：特定顺序和轮次的共识消息，包括预备消息、准备消息和提交消息。
- 共识证明（Consensus proof）：区块的承诺签名，可以证明该区块已经通过了共识过程。
- 快照（Snapshot）：上一个 epoch 的验证者投票状态。

## 共识
IBFT 共识协议从轮次0开始，验证者以轮询的方式选择提议者。然后，提议者会提出一个新的区块提议，并通过PRE-PREPARE消息进行广播。接收到提议者的PRE-PREPARE消息后，其他验证者会验证传入的提议，并进入准备前状态，并广播PREPARE消息。这一步是为了确保所有验证者在同一序号和同一轮次上进行工作。当验证者从其他验证者接收到至少ceil(2N/3)个PREPARE消息时，验证者切换到准备状态并广播COMMIT消息。这一步是通知其他验证者它接受了该提议的区块，并将该区块插入到区块链中。最后，验证者等待ceil(2N/3)个COMMIT消息进入已提交状态，然后将该区块追加到区块链。

伊斯坦布尔BFT协议中的区块是最终的，这意味着没有分叉，并且任何有效的区块必须在主链中的某个位置。为了防止错误节点从主链生成完全不同的链，每个验证者在将区块插入链之前，在区块头的extraData字段中追加ceil(2N/3)个接收到的COMMIT签名。因此，所有区块都是自验证的。然而，动态的extraData会导致区块哈希计算的问题。由于来自不同验证者的相同区块可能具有不同的COMMIT签名集合，因此相同的区块也可能具有不同的区块哈希。为了解决这个问题，我们通过排除COMMIT签名部分来计算区块哈希。因此，我们仍然可以保持区块/区块哈希的一致性，并在区块头中放置共识证明。

共识状态
伊斯坦布尔BFT是一个状态机复制算法。每个验证者维护一个状态机副本，以达到区块共识。IBFT共识中的各个状态包括：

NEW ROUND：提议者发送新的区块提议。验证者等待PRE-PREPARE消息。
PRE-PREPARED：一个验证者接收到PRE-PREPARE消息并广播PREPARE消息。然后它等待至少ceil(2N/3)个PREPARE或COMMIT消息。
PREPARED：一个验证者接收到至少ceil(2N/3)个PREPARE消息并广播COMMIT消息。然后它等待至少ceil(2N/3)个COMMIT消息。
COMMITTED：一个验证者接收到至少ceil(2N/3)个COMMIT消息，并能够将提议的区块插入到区块链中。
FINAL COMMITTED：一个新的区块成功地插入到区块链中，验证者准备进行下一轮。
ROUND CHANGE：一个验证者正在等待相同提议轮次编号的至少ceil(2N/3)个ROUND CHANGE消息。